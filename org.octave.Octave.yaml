app-id: org.octave.Octave
runtime: org.kde.Sdk
runtime-version: 6.6
sdk: org.kde.Sdk
command: octave
rename-icon: octave
sdk-extensions:
  - org.freedesktop.Sdk.Extension.openjdk17
finish-args:
  - --socket=wayland
  - --socket=fallback-x11
  - --share=ipc
  - --device=dri
  - --socket=pulseaudio
  - --share=network
  - --filesystem=host
  - --talk-name=com.canonical.AppMenu.Registrar # required for global menu
  - --talk-name=org.freedesktop.Flatpak # allows spawning processes on the host via flatpak-spawn --host
  - --env=PATH=/app/bin:/usr/bin:/app/jre/bin
  - --env=CPPFLAGS=-I/app/include # required for building some Octave forge packages
  - --env=LDFLAGS=-L/app/lib # required for building some Octave forge packages
  - --env=LD_LIBRARY_PATH=/app/lib # required for linking stand-alone programs with Octave
  - --env=OCTAVE_HOME=/app
  - --env=PKG_CONFIG_PATH=/app/lib/pkgconfig:/app/share/pkgconfig
cleanup:
  - /bin/*lpr*.sh
  - /bin/GraphicsMagick*config
  - /bin/fltk-config
  - /bin/gif2h5
  - /bin/glpsol
  - /bin/h5*
  - /bin/isympy
  - /bin/qconvex
  - /bin/qdelaunay
  - /bin/qhalf
  - /bin/qhull
  - /bin/qvoronoi
  - /bin/rbox
  - /com
  - /examples
  - /include/QSci
  - /lib/cmake
  - /lib/lib*.a
  - /lib/lib*.la
  - /lib/lib*.settings
  - /lib/octave/*/lib*.la
  - /man
  - /share/*.txt
  - /share/COPYING
  - /share/applications/fluid.desktop
  - /share/doc
  - /share/fltk
  - /share/hdf5_examples
  - /share/man
  - /share/units/locale_map.txt
  - /share/zmq
  - fluid
  - fluid.*
build-options:
  env:
    PATH: /app/bin:/usr/bin:/usr/lib/sdk/openjdk11/bin
    PYTHON: python3
modules:
  - name: qscintilla
    buildsystem: qmake
    subdir: Qt4Qt5
    make-install-args:
      - DESTDIR=/app
      - PREFIX=/app
    config-opts:
      - CONFIG+=release
    sources:
      - type: archive
        url: https://www.riverbankcomputing.com/static/Downloads/QScintilla/2.11.6/QScintilla-2.11.6.tar.gz
        sha256: e7346057db47d2fb384467fafccfcb13aa0741373c5d593bc72b55b2f0dd20a7
        # Failed to check archive qscintilla/QScintilla-2.11.6.tar.gz with AnityaChecker: Wrong content type 'text/plain' received
        # from 'https://www.riverbankcomputing.com/static/Downloads/QScintilla/2.14.1/QScintilla_src-2.14.1.tar.gz
        # x-checker-data:
        #   type: anitya
        #   project-id: 10082
        #   url-template: https://www.riverbankcomputing.com/static/Downloads/QScintilla/$version/QScintilla_src-$version.tar.gz
      - type: shell
        commands:
          - sed -e 's|\(target.path\) = .*|\1 = /app/lib|' -e 's|\(header.path\) =
            .*|\1 = /app/include|' -e 's|\(trans.path\) = .*|\1 = /app/share/qt5/translations|'
            -e 's|\(qsci.path\) = .*|\1 = /app/share/qt5|' -e 's|\(features.path\)
            = .*|\1 = /app/lib/qt5/mkspecs/features|' -i Qt4Qt5/qscintilla.pro
  - name: openblas # dependency of the suitesparse module
    no-autogen: true
    make-args:
      - DYNAMIC_ARCH=1
      - DYNAMIC_OLDER=1
      - FC=gfortran
      - NO_CBLAS=1
      - NO_LAPACKE=1
      - TARGET=GENERIC
      - USE_OPENMP=0 # OpenMP off by default, this hack skips 'test_fork' which crashes on i386
    make-install-args:
      - PREFIX=/app
    sources:
      - type: archive
        url: https://github.com/xianyi/OpenBLAS/archive/v0.3.24.tar.gz
        sha256: ceadc5065da97bd92404cac7254da66cc6eb192679cf1002098688978d4d5132
        x-checker-data:
          type: anitya
          project-id: 2540
          url-template: https://github.com/xianyi/OpenBLAS/archive/v$version.tar.gz
  - name: mpfr # dependency of the suitesparse module
    sources:
      - type: archive
        url: https://www.mpfr.org/mpfr-current/mpfr-4.2.1.tar.xz
        sha256: 277807353a6726978996945af13e52829e3abd7a9a5b7fb2793894e18f1fcbb2
        x-checker-data:
          type: anitya
          project-id: 2019
          url-template: https://www.mpfr.org/mpfr-current/mpfr-$version.tar.xz
  - name: suitesparse
    make-args:
      - BLAS=-lopenblas
      - LAPACK=
      - library
      # https://github.com/DrTimothyAldenDavis/SuiteSparse#about-the-blas-and-lapack-libraries
      - CMAKE_OPTIONS="-DCMAKE_INSTALL_PREFIX=/app"
    make-install-args:
      - BLAS=-lopenblas
      - LAPACK=
      - INSTALL_INCLUDE=/app/include/suitesparse
      - INSTALL_LIB=/app/lib
      - library
      - MPFR_ROOT=/app
      # https://github.com/DrTimothyAldenDavis/SuiteSparse/blob/dev/SuiteSparse_config/CMakeLists.txt#L153
      - SUITESPARSE_LIBDIR=/app/lib
      - SUITESPARSE_BINDIR=/app/bin
      - SUITESPARSE_LIBDIR=/app/include
    no-autogen: true
    sources:
      - type: archive
        url: https://github.com/DrTimothyAldenDavis/SuiteSparse/archive/refs/tags/v7.0.1.tar.gz
        sha256: dc2f8d5c2657c120b30cce942f634ec08fc3a4b0b10e19d3eef7790b2bec8d1e
        # Octave 8.2.0 is incompatible with SuiteSparse 7.1.0:
        # https://github.com/gnu-octave/octave/commit/7ea31a1eefe6ce56b15c68011f50b444f9ba3adc
        # x-checker-data:
        #   type: anitya
        #   project-id: 4908
        #   url-template: https://github.com/DrTimothyAldenDavis/SuiteSparse/archive/refs/tags/v$version.tar.gz
        # Comment out the modules that we don't need.
      - type: shell
        commands:
          - sed -i '/SLIP_LU/ s/^/# /' Makefile
          - sed -i '/Mongoose/ s/^/# /' Makefile
          - sed -i '/LDL/ s/^/# /' Makefile
          - sed -i '/RBio/ s/^/# /' Makefile
          - sed -i '/SPQR/ s/^/# /' Makefile
          - sed -i '/GraphBLAS/ s/^/# /' Makefile
  - name: octave
    config-opts:
      - --with-qt=6
      - --disable-silent-rules
      - --with-blas=openblas
      - --with-java-homedir=/app/jre
      - --with-java-includedir=/usr/lib/sdk/openjdk11/jvm/openjdk-11/include
    # workaround for https://savannah.gnu.org/bugs/?55547
    # these are the build flags used in the Freedesktop SDK, without "target_flags_glibcxx_assertions":
    # https://gitlab.com/freedesktop-sdk/freedesktop-sdk/-/blob/master/include/flags.yml
    build-options:
      cflags: -O2 -g -pipe -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong
        -grecord-gcc-switches
      cflags-override: true
      cxxflags: -O2 -g -pipe -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong
        -grecord-gcc-switches
      cxxflags-override: true
    # Disabled due to https://gitlab.com/freedesktop-sdk/freedesktop-sdk/-/issues/1558
    # build-commands:
    # - make check
    cleanup:
      - /share/icons/hicolor/1024x1024 # workaround for https://savannah.gnu.org/bugs/?55836
    sources:
      - type: git
        url: https://github.com/gnu-octave/octave.git
        commit: 626423d9c505dde5ee444d5f2c2d358d55bb7a39
      - type: git
        url: https://github.com/coreutils/gnulib.git
        commit: 811698980f0ba2d975e0e9e7f28a53740df58b1a
        dest: gnulib
    commands:
      - GNULIB_URL=https://github.com/coreutils/gnulib.git ./bootstrap
